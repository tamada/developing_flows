#  プログラムを書き始めよう

[プログラムを書き始める前に](first.md) に書かれた内容が全てできていれば，ソフトウェアのリポジトリがGitHubに作成され，ローカルにもリポジトリのコピーが存在するはずである．それを踏まえて，次の手順でプログラムを書き始めよう．

* [ビルドファイルを用意する．](ビルドファイルを用意する)
* [CIを整備する．](#CIを整備する)
* [テストデータを準備する．](#テストデータを準備する)
* [プログラムを書き始める．](#プログラムを書き始める)

## ビルドファイルを用意する

プログラムを書き始めてすぐに準備すべきことはCI（Continuous Integration）である．push時にコンパイル，テスト，デプロイまで行う必要がある．CIを準備するのは大変な作業である．であるが故に，最初に用意し，実施できるようにする必要がある．そうでなければ，いつまで経ってもCIが実施されないまま開発が進むことになる．

そして，CIを実施するためには，ビルドツールによるビルドが必須である．そのため，リポジトリが準備できてすぐに行うべきことがビルドファイルの用意である．

### ビルドで行うべきこと

ビルドでは，依存ライブラリの取得，コンパイル，テストを行う．そのため，ビルドファイルではコンパイル，テストが速やかに行われるように設定する．

依存ライブラリの取得では，作成するソフトウェアが依存するライブラリをダウンロードし，コンパイルに利用できるようにすることである．コンパイルとは，ソースファイルからオブジェクトファイル，実行ファイルに変換することである．

テストは，[xUnit](https://ja.wikipedia.org/wiki/XUnit)を用いて自動テストを実施することである．続くCIにも関連するが，ここでカバレッジ計測まで行っておく．テストを実施するだけでは不十分で，カバレッジ計測まで行う必要がある．カバレッジ計測を行わない場合，テストが十分であるかを判断する材料がなくなるためである．

### どのビルドツールを利用するか

言語ごとに標準的なものを利用すると良い．ただし最低限の条件として，パッケージマネージャがついていることがあげられる．もちろん，自分自身がよく知っているものがあれば，レガシーなものでない限り，それを使い続ければ良い．

* Java
  * これから勉強を始めるのであれば，[Gradle](https://gradle.org/)一択．
  * [Maven](https://maven.apache.org)を使い慣れているのでれば使い続けるのは良いかもしれない．ただし，速やかにGradleに移行する方が良い．`pom.xml`は意外と様々なことを書かないといけないし，XMLはやはり書きにくい．
  * [Apache Ant](https://ant.apache.org/)は捨てた方が良い．
    パッケージマネージャが使えない，手続き的に書いてしまうなど，今日の開発における問題が多すぎる．ビルドファイルのメンテナンスに手間がかかり過ぎる．
* Go
  * Makeになるであろう．
  * [Bazelも便利らしい](https://medium.com/mixi-developers/go-project-with-bazel-ad807ba19f5c)．
* Ruby（よく知らない）
  * Rakeになると思う．
* Rust（よく知らない）
  * Cargo一択．
* JavaScript（よく知らない）
  * npm もしくは yarn
    * npmもyarnもパッケージマネージャであるが，`package.json`の中に`scripts`という要素が書ける．`npm run`や`yarn run`で`scripts`の中の特定の要素を実行できるため，

## CIを整備する

### CIで行うべきこと

CIはpushやプルリクエストの発行の度に，主に以下のことを自動的に実行するよう設定する必要がある．

* テストカバレッジを計測する．
* プログラムの品質を計測する．
* ソフトウェアをデプロイする．

これらのことを実行するようになると，ソースコードの品質の低下をいち早く検出でき，改善すべき箇所がわかるようになる．品質を一定以上に保つためには必要なことである．
加えてCIで検査することにより，テストで失敗した場合にプルリクエストがマージできなくなるため，`main`（`master`）ブランチのビルドが壊れないことがある程度保証される．

CIの設定が済めば`README.md`に必要なバッジ（少なくとも以下のもの）を追加しよう．

* CIのビルドが通ったこと
* テストカバレッジ
* プログラムの品質

これにより，CIをやっている，テストを通している，カバレッジがどの程度であることを利用者に示せることになり，最低限のことをしているとアピールできる．

### 利用するCIツール

基本的に好きなものを利用すれば良いが，自前で準備する場合，有償でも良い場合，無償で行う場合などがある．著名なCIサービスは次の通り．OSS向けには無料で使えるものが多い．

* [Circle CI](https://circleci.com/)（[料金プラン](https://circleci.com/ja/pricing/)）
* [TravisCI](https://travis-ci.com)（[料金プラン](https://www.travis-ci.com/plans)）

GitHubやGitLabには標準機能としてCI/CDが用意されている．

* [GitHub Actions](https://github.co.jp/features/actions)
* [GitLab CI/CD](https://docs.gitlab.com/ee/ci/)

自らサーバを立てるのであれば，[Jenkins](https://www.jenkins.io)が古くから使われていて良い．

いずれのCIサービス/ツールを使うにしろ，行うべき処理をスクリプトとして記述する必要がある．スクリプトの詳細は，各CIサービス/ツールのドキュメントを参照されたい．

## テストデータを準備する

ここでは，サンプルの入力データを準備する．`README.md`に書いたようなデータが良いであろう．
このデータを準備することにより，プログラムを書いた直後にテストが行えるようになる．

特に複雑な入力データを要する場合は，テストデータの準備は必須である．後回しにすればするほど，準備のハードルが上がり，準備に対する心理的障害が増大していく．

なお，テストデータが，JSONやXML，Markdownなどの何らかのフォーマットであった場合，lintツールでフォーマットを検証しておくことを推奨する．フォーマットが間違っていたり，読みにくかったりすると，後々修正しなければならなくなる．それを防止するため，事前に検証しておこう．

* [htmllint](https://www.npmjs.com/package/htmllint)
* [xmllint](http://xmlsoft.org/xmllint.html)
* [jsonlint](https://github.com/zaach/jsonlint)
* [markdownlint](https://github.com/DavidAnson/markdownlint)
* [yamllint](https://github.com/adrienverge/yamllint)

## プログラムを書き始める

### おおっとその前に

これから何を行うかをチケットに登録しよう．
登録するチケットは一つで構わない．
これから何に取り組むのかを明らかにするためである．
ここで登録したチケットが完成すれば，commit，pushし，プルリクエストを発行することになる．
そのため，その程度の規模でチケットを登録しよう．

なお，これからの作業を全て洗い出して全てをチケットに登録するようにすると，[TiDD](https://www.amazon.co.jp/dp/4798125067/)となるであろう．

### ブランチを切る

利用する開発フローが[GitLabフロー](https://postd.cc/gitlab-flow/)でない限り，`main`ブランチに直接コミットは行わない．`main`ブランチから新たなブランチを派生させ，そこで開発を始めよう．

gitのブランチの名前の決め方は色々とあるが，どのような命名方法でも良い．とにかくブランチを切って，`main`は常に動作する状態に置いておくことが重要である．

### IDEを開いてプログラムを書き始める

ここまで準備してようやくプログラムを書き始める．どのような順序で書いても良いが，著者の場合は次のような順番で書く（以下の箇条書きの各項目が一つのチケットの単位とすることが多い）．

* `main`メソッドでオプション解析を行う．
  * `README.md`に書いたヘルプメッセージと同じものが出力できるようにする．
* オプションなしで実行した時の，デフォルトの結果が出力されるようにする．
* オプションに一つずつ対応していく．

動作確認のため，テストコードも書いておくと良い．
テストコードを書いておくと，CI時にカバレッジなども計測してくれる（ように設定したハズである）．

なお，プロダクトコードに先駆けてテストコードから書くと，[TDD](https://www.amazon.co.jp/dp/4274217884/)となる．

### commit, pushする

さて，チケットに登録した分のプログラムを書き，動作確認も済めばいよいよcommitである．commitするときは，関係する変更を一回のコミットに含めるようにする必要がある．

コミットにはコミットコメントを含める必要がある．コミットコメントは，[1行目に概要，2行目は空行で，3行目以降に詳細を書け](https://postd.cc/how-to-write-a-git-commit-message/)，というように言われている．本来であれば，それに従い，書けば良いのであるが，コミットメッセージを書き慣れていない状態でそのような書き方を要求されると疲れてしまう．そのため，まずは1行目の概要のみのコミットメッセージでコミットしてみよう．

コミットできれば，pushしよう．

#### 参考リンク

* [GitHubで使われている実用英語コメント集](https://qiita.com/shikichee/items/a5f922a3ef3aa58a1839)
* [ネイティブと働いて分かった英語コミットメッセージの頻出動詞10つ](https://qiita.com/gogotanaka/items/b65e1b081fa976e5d754)
* [英語で書いてあるコミットログの動詞が現在形のわけ](https://moznion.hatenadiary.com/entry/20130122/1358834668)
* [コミットメッセージは命令形が正しい](https://note.com/muyooo/n/n1f34e2ef4808)
* [提言: コミットメッセージの一行目には要求仕様を書け](https://qiita.com/magicant/items/882b5142c4d5064933bc)

### プルリクエストを発行し，マージする

pushができれば，GitHubの画面を開き，プルリクエストを発行しよう．プルリクエストを発行すると，CIが動作し出すハズである．CIでの検査が終わるのを待とう．

CIでのビルドをパスすれば，プルリクエストをマージし，ローカルにcloneしたリポジトリにも変更を取り込もう（`main`ブランチをpullしよう）．これが終われば，再び[プログラムを書き始める](#プログラムを書き始める)の項目を最初から実践し，ソフトウェアを完成に近付けていこう．

